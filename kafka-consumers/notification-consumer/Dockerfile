# Use a base image
FROM amazoncorretto:17

# Create a non-root user
ARG USER=knowhowuser
ARG UID=1000
ARG GID=1000

RUN ln -sf /bin/bash /bin/sh \
    && yum install -y shadow-utils \
    && groupadd -g $GID $USER \
    && useradd -u $UID -g $GID -m -s /bin/bash $USER

# Set the working directory
WORKDIR /app

# Set the ownership of the working directory to the non-root user
RUN chown -R $USER:$USER /app

# Set environment variables for volumes
ENV TMP_DIR="/tmp"
ENV APP_DIR="/app"
ENV PROPERTIES_DIR="/app/properties"
ENV OFFLINE_DATA_DIR="/app/offline_data"

# Create the volumes
VOLUME $TMP_DIR
VOLUME $APP_DIR
VOLUME $PROPERTIES_DIR
VOLUME $OFFLINE_DATA_DIR

# Set environment variables
ENV CONFIG_LOCATION="/app/properties/notification-consumer.properties"
ENV JAVA_OPTS=""

# Set the JAR file variable
ARG NOTIFICATION_CONSUMER_JAR_FILE
ADD ${NOTIFICATION_CONSUMER_JAR_FILE} $APP_DIR/notification-consumer.jar

# Copy application.properties file
ADD kafka-consumers/notification-consumer/src/main/resources/application.properties $PROPERTIES_DIR/notification-consumer.properties

# Expose port
EXPOSE 50020

# Set permissions for the JAR file
RUN chown $USER:$USER $APP_DIR/notification-consumer.jar

# Switch to the non-root user
USER $USER:$GID

# Entrypoint command
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar notification-consumer.jar --spring.config.location=classpath:/BOOT-INF/classes/application.properties --spring.config.additional-location=optional:file:/app/properties/notification-consumer.properties"]
