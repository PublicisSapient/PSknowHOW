<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  Copyright 2014 CapitalOne, LLC.
  Further development Copyright 2022 Sapient Corporation.
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
     http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

<p-toast [style]="{ marginTop: '80px' }"></p-toast>
<div class="p-col-12 horizontal-tabs">
  <div class="main">
    <div class="tabs-container">
      <p-button
        *ngFor="let item of tabHeaders"
        label="{{ item?.toUpperCase() }}"
        icon="pi pi-{{ item?.toLowerCase() }}"
        class="btn-tab pi-{{ item?.toLowerCase() }}-button"
        [ngClass]="{ 'btn-active': item?.toLowerCase() === 'scrum' }"
        (click)="kanbanActivation(item?.toLowerCase())"
      ></p-button>
    </div>
    <div
      class="tabs-content test-execution-content"
      *ngIf="
        trendLineValueList && trendLineValueList?.length > 0;
        else noDataTemp
      "
    >
      <div class="p-xl-12 p-pl-0 p-p-r-0 p-pb-2">
        <div class="p-xl-12 p-pl-0 p-p-r-0">
          <form [formGroup]="filterForm" class="p-xl-12 p-p-0">
            <div class="p-xl-12 p-d-flex p-pl-0 p-pb-3">
              <div
                class="form-check filter-box p-xl-4 trend-line-container p-pl-0"
              >
                <ng-select
                  formControlName="selectedProjectValue"
                  (change)="handleIterationFilters('project', false)"
                  placeholder="Project"
                  [clearable]="false"
                  class="p-pb-0"
                >
                  <ng-option
                    *ngFor="let item of trendLineValueList"
                    [value]="item.nodeId"
                    >{{ item.nodeDisplayName }}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </form>
        </div>

        <div #capacityTemp>
          <div
            class="p-xl-12 p-pl-0 p-p-r-0 capcity-kanban-table"
            *ngIf="kanban; else capacityScrumDataTable"
          >
            <div
              class="p-xl-12 p-pl-0 p-p-r-0"
              *ngIf="checkIfGridDataIdEmpty(); else noDataTemp"
            >
              <div class="p-xl-12 p-pl-0 p-p-r-0 p-mb-2 table-header">
                {{ tabContentHeaders[selectedView] }}
              </div>
              <p-table
                [columns]="getGridColumns()"
                [value]="getGridData()"
                class="capacity-table custom-grid"
                loadingIcon="loading-img"
                [expandedRowKeys]="expandedRows"
                [dataKey]="getDataKey()"
                (onRowExpand)="onCapacitySprintRowSelection()"
                rowExpandMode="single"
              >
                <ng-template pTemplate="header" let-columns>
                  <tr>
                    <th
                      scope="col"
                      *ngFor="let col of columns"
                      class="upload_sprint_capacity"
                    >
                      {{ col.header }}
                    </th>
                    <th scope="col" class="upload_sprint_capacity">Action</th>
                  </tr>
                </ng-template>
                <ng-template
                  pTemplate="body"
                  let-item
                  let-columns="columns"
                  let-expanded="expanded"
                >
                  <tr
                    class="sprint"
                    [ngClass]="getExpandedClass(item,expanded)"
                    [pRowToggler]="item"
                    [pRowTogglerDisabled]="!isToggleEnableForSelectedProject"
                  >
                    <td
                      *ngFor="let col of columns; let i = index"
                      [ngClass]="{
                        'text-blue': (item[col.field] | typeof) === 'number'
                      }"
                      class="upload_sprint_capacity sprint p-pl-3"
                    >
                      <button
                        *ngIf="i === 0 && isToggleEnableForSelectedProject"
                        type="button"
                        pButton
                        pRipple
                        class="p-button-text p-button-plain expand-btn"
                        [icon]="
                          expanded
                            ? 'pi pi-chevron-down'
                            : 'pi pi-chevron-right'
                        "
                      ></button>
                      <span
                        *ngIf="
                          col.field === 'startDate' || col.field === 'endDate';
                          else otherFieldsTemp
                        "
                      >
                        {{ item[col.field] | isoDateFormat }}
                      </span>
                      <ng-template #otherFieldsTemp>
                        {{ item[col.field] ? item[col.field] : '- -' }}
                      </ng-template>
                    </td>
                    <td class="upload_sprint_capacity">
                      <button
                        pButton
                        type="button"
                        [disabled]="!isAdminForSelectedProject"
                        title="{{
                          !isAdminForSelectedProject
                            ? 'You are not an admin'
                            : ''
                        }}"
                        class="p-button-sm btn-active edit-btn"
                        label="{{
                          isToggleEnableForSelectedProject
                            ? 'Manage Users'
                            : item.capacity
                            ? 'Edit Capacity'
                            : 'Add Capacity'
                        }}"
                        (click)="
                          isToggleEnableForSelectedProject
                            ? manageAssignees(item)
                            : AddOrUpdateData(item)
                        "
                        iconPos="right"
                        [loading]="
                          isToggleEnableForSelectedProject
                            ? jiraAssigneeLoader
                            : false
                        "
                      ></button>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-item>
                  <tr [pSelectableRow]="item" class="row-expansion">
                    <td
                      colspan="5"
                      [style]="{ display: 'block' }"
                      class="p-pb-2"
                    >
                      <div>
                        <div class="p-d-flex p-justify-between p-align-center">
                          <div class="p-d-flex p-align-center">
                            <h3 class="color-grey">Added Users</h3>
                            &nbsp;&nbsp;
                            <p>
                              (*If the desired Domain name is not visible,
                              kindly contact us on
                              knowhowfeedback&#64;publicissapient.com)
                            </p>
                          </div>
                          <p-button
                            styleClass="p-button-secondary p-button-sm edit-button"
                            [disabled]="!isAdminForSelectedProject"
                            title="{{
                              !isAdminForSelectedProject
                                ? 'You are not an admin'
                                : ''
                            }}"
                            (click)="onSprintCapacityEdit(item)"
                            *ngIf="!projectCapacityEditMode"
                            [disabled]="!item?.assigneeCapacity?.length > 0"
                          >
                            <img
                              alt="edit logo"
                              src="../../../assets/img/edit.svg"
                              style="width: 0.75rem"
                            />
                            <span class="p-pl-2">Edit</span>
                          </p-button>
                        </div>

                        <p-table
                          [value]="item?.assigneeCapacity"
                          dataKey="userId"
                          [paginator]="true"
                          [rows]="20"
                          [rowsPerPageOptions]="[20, 25, 30]"
                          [showCurrentPageReport]="true"
                          [tableStyle]="{ 'max-width': '1000px' }"
                        >
                          <ng-template pTemplate="header">
                            <tr class="expanded-table-header-row">
                              <th
                                scope="col"
                                pSortableColumn="userName"
                                class="expanded-table-header-cell"
                              >
                                User Name
                                <p-sortIcon field="userName"> </p-sortIcon>
                              </th>

                              <th
                                scope="col"
                                pSortableColumn="email"
                                class="expanded-table-header-cell"
                              >
                                <!--[style]="{'max-width':'170px'}"-->
                                <div>
                                  <span
                                    [ngClass]="{
                                      editable: projectCapacityEditMode
                                    }"
                                    >Email Id</span
                                  >
                                </div>
                              </th>

                              <th
                                scope="col"
                                pSortableColumn="role"
                                class="expanded-table-header-cell"
                              >
                                Domain
                                <p-sortIcon field="role"></p-sortIcon>
                              </th>

                              <th
                                scope="col"
                                pSortableColumn="squad"
                                class="expanded-table-header-cell"
                                *ngIf="selectedSquad.length > 0"
                              >
                                Squad <p-sortIcon field="squad"></p-sortIcon>
                              </th>

                              <th
                                scope="col"
                                pSortableColumn="plannedCapacity"
                                class="expanded-table-header-cell"
                              >
                                Planned Capacity (in Hrs)
                                <p-sortIcon
                                  field="plannedCapacity"
                                ></p-sortIcon>
                              </th>
                              <th
                                scope="col"
                                pSortableColumn="leaves"
                                class="expanded-table-header-cell"
                              >
                                Leaves (in Hrs)
                                <p-sortIcon field="leaves"> </p-sortIcon>
                              </th>
                              <th
                                scope="col"
                                pSortableColumn="availableCapacity"
                                class="expanded-table-header-cell"
                              >
                                Available Capacity (in Hrs)
                                <p-sortIcon
                                  field="availableCapacity"
                                ></p-sortIcon>
                              </th>
                            </tr>
                          </ng-template>
                          <ng-template
                            pTemplate="body"
                            let-assignee
                            let-rowIndex="rowIndex"
                          >
                            <tr class="expanded-table-body-row">
                              <td class="expanded-table-body-cell">
                                {{
                                  assignee?.userName
                                    ? assignee?.userName
                                    : '- -'
                                }}
                              </td>

                              <td
                                class="expanded-table-body-cell"
                                [style]="{
                                  'max-width': '170px',
                                  'word-wrap': 'break-word'
                                }"
                              >
                                <p-multiSelect
                                  [options]="projectAssigneeEmailsCopy"
                                  *ngIf="
                                    projectCapacityEditMode;
                                    else showUserEmail
                                  "
                                  defaultLabel="Select Emails"
                                  class="multiselect-custom"
                                  [style]="{ width: '160px' }"
                                  display="chip"
                                  showClear="true"
                                  optionLabel="name"
                                  optionValue="value"
                                  [formControl]="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.email
                                  "
                                  (onChange)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'email'
                                    )
                                  "
                                  (onClear)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'email',
                                      true
                                    )
                                  "
                                >
                                </p-multiSelect>

                                <ng-template #showUserEmail>{{
                                  assignee?.email ? assignee?.email : '- -'
                                }}</ng-template>
                              </td>

                              <td class="expanded-table-body-cell">
                                <p-dropdown
                                  placeholder="Select Domain"
                                  [options]="projectAssigneeRoles"
                                  optionLabel="name"
                                  optionValue="value"
                                  *ngIf="projectCapacityEditMode; else showRole"
                                  [style]="{ width: '200px' }"
                                  [formControl]="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.role
                                  "
                                  (onChange)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'role'
                                    )
                                  "
                                ></p-dropdown>
                                <ng-template #showRole>{{
                                  assignee?.role
                                    ? projectAssigneeRolesObj[assignee?.role]
                                    : '- -'
                                }}</ng-template>
                              </td>

                              <td
                                class="expanded-table-body-cell"
                                *ngIf="selectedSquad.length > 0"
                              >
                                <p-dropdown
                                  placeholder="Select Squad"
                                  [options]="selectedSquad"
                                  optionLabel="nodeName"
                                  optionValue="nodeId"
                                  *ngIf="
                                    projectCapacityEditMode;
                                    else showSquad
                                  "
                                  [style]="{ width: '150px' }"
                                  [formControl]="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.squad
                                  "
                                  (onChange)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'squad'
                                    )
                                  "
                                ></p-dropdown>
                                <ng-template #showSquad>
                                  {{ getNodeName(assignee) }}
                                </ng-template>
                              </td>
                              <td class="expanded-table-body-cell">
                                <input
                                  type="number"
                                  min="0"
                                  pInputText
                                  [style]="{ width: '60px' }"
                                  *ngIf="
                                    projectCapacityEditMode;
                                    else showPlannedCapacity
                                  "
                                  (input)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'plannedCapacity'
                                    )
                                  "
                                  [formControl]="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.plannedCapacity
                                  "
                                  (keypress)="validateInput($event)"
                                />
                                <ng-template #showPlannedCapacity>{{
                                  assignee?.plannedCapacity
                                    ? assignee?.plannedCapacity
                                    : '- -'
                                }}</ng-template>
                              </td>
                              <td
                                class="expanded-table-body-cell"
                                [style]="{ position: 'relative' }"
                              >
                                <input
                                  type="number"
                                  min="0"
                                  (keypress)="validateInput($event)"
                                  pInputText
                                  *ngIf="
                                    projectCapacityEditMode;
                                    else showLeaves
                                  "
                                  [style]="{ width: '60px' }"
                                  [formControl]="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.leaves
                                  "
                                  (input)="
                                    calculateAvaliableCapacity(
                                      assignee,
                                      this.selectedSprintAssigneFormArray[
                                        rowIndex
                                      ],
                                      'leaves'
                                    )
                                  "
                                  [ngClass]="{
                                    'ng-invalid':
                                      selectedSprintAssigneFormArray[rowIndex]
                                        ?.leaves?.errors
                                  }"
                                />
                                <small
                                  *ngIf="
                                    selectedSprintAssigneFormArray[rowIndex]
                                      ?.leaves?.errors &&
                                    projectCapacityEditMode
                                  "
                                  class="p-error-block"
                                  >value must be less than or equal to
                                  plannedCapacity.</small
                                >
                                <ng-template #showLeaves>{{
                                  assignee?.leaves
                                    ? assignee?.leaves
                                    : '-
                                                -'
                                }}</ng-template>
                              </td>
                              <td class="expanded-table-body-cell">
                                {{
                                  assignee?.availableCapacity
                                    ? assignee?.availableCapacity
                                    : '- -'
                                }}
                              </td>
                            </tr>
                          </ng-template>
                          <ng-template pTemplate="emptymessage">
                            <tr class="expanded-table-body-row">
                              <td
                                colspan="5"
                                class="expanded-table-body-cell no-assignee"
                              >
                                Click on Manage Users to add users.
                              </td>
                            </tr>
                          </ng-template>
                        </p-table>

                        <div
                          class="p-d-flex p-justify-end p-mt-3 p-mb-3"
                          *ngIf="projectCapacityEditMode"
                        >
                          <button
                            pButton
                            pRipple
                            label="Cancel"
                            icon="pi pi-times"
                            class="p-button-cancel p-button-outlined p-button-secondary p-button-text p-mr-2 p-button-sm"
                            (click)="onSprintCapacityCancel(item)"
                          ></button>

                          <button
                            pButton
                            pRipple
                            label="Save"
                            icon="pi pi-save"
                            class="p-button-secondary p-button-sm"
                            (click)="onSprintCapacitySave(item)"
                            [disabled]="
                              !isAdminForSelectedProject ||
                              selectedSprintAssigneValidator?.length > 0
                            "
                          ></button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
            <ng-template #noDataTemp>
              <div
                class="p-xl-12 p-pl-0 p-p-r-0 no-data-available"
                *ngIf="noData"
              >
                No data Available for Selected Project
              </div>
              <div
                class="p-xl-12 p-pl-0 p-p-r-0 no-data-available"
                *ngIf="tableLoader && !loader"
              >
                <div class="min-ht">
                  <div class="loading-img"></div>
                </div>
              </div>
            </ng-template>
          </div>
          <ng-template #capacityScrumDataTable>
            <div
              class="p-xl-12 p-pl-0 p-p-r-0 capcity-scrum-table"
              *ngIf="checkIfGridDataIdEmpty(); else noDataTemp"
            >
              <div class="p-xl-12 p-pl-0 p-p-r-0 p-mb-2 table-header">
                {{ tabContentHeaders[selectedView] }}
              </div>
              <div class="">
                <p-table
                  [columns]="getGridColumns()"
                  [value]="getGridData()"
                  [dataKey]="getDataKey()"
                  class="capacity-table custom-grid"
                  (onRowExpand)="onCapacitySprintRowSelection()"
                  [expandedRowKeys]="expandedRows"
                  loadingIcon="loading-img"
                  expandableRows="true"
                  rowExpandMode="single"
                >
                  <ng-template pTemplate="header" let-columns>
                    <tr>
                      <th
                        scope="col"
                        *ngFor="let col of columns"
                        class="upload_sprint_capacity"
                      >
                        {{ col.header }}
                      </th>
                      <th scope="col" class="upload_sprint_capacity">Action</th>
                    </tr>
                  </ng-template>
                  <ng-template
                    pTemplate="body"
                    let-item
                    let-columns="columns"
                    let-expanded="expanded"
                  >
                    <tr
                      class="sprint"
                      [ngClass]="getExpandedClass(item,expanded)"
                      [pRowToggler]="item"
                      [pRowTogglerDisabled]="!isToggleEnableForSelectedProject"
                    >
                      <td
                        class="upload_sprint_capacity p-pl-3"
                        *ngFor="let col of columns; let i = index"
                        [ngClass]="{
                          'text-blue': (item[col.field] | typeof) === 'number'
                        }"
                      >
                        <button
                          *ngIf="i === 0 && isToggleEnableForSelectedProject"
                          type="button"
                          pButton
                          pRipple
                          class="p-button-text p-button-plain expand-btn"
                          [icon]="
                            expanded
                              ? 'pi pi-chevron-down'
                              : 'pi pi-chevron-right'
                          "
                        ></button>
                        {{ item[col.field] ? item[col.field] : '- -' }}
                      </td>
                      <td class="upload_sprint_capacity">
                        <button
                          pButton
                          type="button"
                          class="p-button-sm btn-active edit-btn"
                          [disabled]="!isAdminForSelectedProject"
                          label="{{
                            isToggleEnableForSelectedProject
                              ? 'Manage Users'
                              : item.capacity
                              ? 'Edit Capacity'
                              : 'Add Capacity'
                          }}"
                          title="{{
                            !isAdminForSelectedProject
                              ? 'You are not an admin'
                              : ''
                          }}"
                          (click)="
                            isToggleEnableForSelectedProject
                              ? manageAssignees(item)
                              : AddOrUpdateData(item)
                          "
                          iconPos="right"
                          [loading]="
                            isToggleEnableForSelectedProject
                              ? jiraAssigneeLoader
                              : false
                          "
                        ></button>
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="rowexpansion" let-item>
                    <tr [pSelectableRow]="item" class="row-expansion">
                      <td
                        colspan="5"
                        [style]="{ display: 'block' }"
                        class="p-pb-2"
                      >
                        <div class="capacity-table-container">
                          <div
                            class="p-d-flex p-justify-between p-align-center"
                          >
                            <div class="p-d-flex p-align-center">
                              <h3 class="color-grey">Added Users</h3>
                              &nbsp;&nbsp;
                              <p>
                                (*If the desired Domain name is not visible,
                                kindly <br />
                                contact us on
                                ''knowhowfeedback&#64;publicissapient.com'')
                              </p>
                            </div>
                            <p-button
                              styleClass="p-button-secondary p-button-sm edit-button"
                              title="{{
                                !isAdminForSelectedProject
                                  ? 'You are not an admin'
                                  : ''
                              }}"
                              (click)="onSprintCapacityEdit(item)"
                              *ngIf="!projectCapacityEditMode"
                              [disabled]="
                                !isAdminForSelectedProject ||
                                !item?.assigneeCapacity?.length > 0
                              "
                            >
                              <img
                                alt="edit logo"
                                src="../../../assets/img/edit.svg"
                                style="width: 0.75rem"
                              />
                              <span class="p-pl-2">Edit</span>
                            </p-button>
                          </div>

                          <div>
                            <p-table
                              [value]="item.assigneeCapacity"
                              dataKey="userId"
                              [paginator]="true"
                              [rows]="20"
                              [rowsPerPageOptions]="[20, 25, 30]"
                              [showCurrentPageReport]="true"
                            >
                              <ng-template pTemplate="header">
                                <tr class="expanded-table-header-row">
                                  <th
                                    scope="col"
                                    pSortableColumn="userName"
                                    class="expanded-table-header-cell"
                                    [style]="{ width: '25%' }"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >User Name</span
                                      >
                                      <p-sortIcon field="userName"></p-sortIcon>
                                    </div>
                                  </th>
                                  <th
                                    scope="col"
                                    pSortableColumn="email"
                                    class="expanded-table-header-cell"
                                    [style]="{ 'max-width': '170px' }"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Email Id</span
                                      >
                                    </div>
                                  </th>
                                  <th
                                    scope="col"
                                    pSortableColumn="happinessRating"
                                    class="expanded-table-header-cell"
                                    [style]="{ width: '25%' }"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Happiness Rating</span
                                      >
                                    </div>
                                  </th>
                                  <th
                                    scope="col"
                                    pSortableColumn="role"
                                    class="expanded-table-header-cell"
                                    [style]="{ width: '25%' }"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Domain</span
                                      >
                                      <p-sortIcon field="role"></p-sortIcon>
                                    </div>
                                  </th>

                                  <th
                                    scope="col"
                                    pSortableColumn="squad"
                                    class="expanded-table-header-cell"
                                    [style]="{ width: '25%' }"
                                    *ngIf="selectedSquad.length > 0"
                                  >
                                    Squad
                                    <p-sortIcon field="squad"></p-sortIcon>
                                  </th>

                                  <th
                                    scope="col"
                                    pSortableColumn="plannedCapacity"
                                    class="expanded-table-header-cell"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Planned Capacity <br />(in Hrs)</span
                                      >
                                      <p-sortIcon
                                        field="plannedCapacity"
                                      ></p-sortIcon>
                                    </div>
                                  </th>
                                  <th
                                    scope="col"
                                    pSortableColumn="leaves"
                                    class="expanded-table-header-cell"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Leaves<br />
                                        (in Hrs)</span
                                      >
                                      <p-sortIcon field="leaves"></p-sortIcon>
                                    </div>
                                  </th>
                                  <th
                                    scope="col"
                                    pSortableColumn="availableCapacity"
                                    class="expanded-table-header-cell"
                                  >
                                    <div>
                                      <span
                                        [ngClass]="{
                                          editable: projectCapacityEditMode
                                        }"
                                        >Available Capacity <br />
                                        (in Hrs)</span
                                      >
                                      <p-sortIcon
                                        field="availableCapacity"
                                      ></p-sortIcon>
                                    </div>
                                  </th>
                                </tr>
                              </ng-template>
                              <ng-template
                                pTemplate="body"
                                let-assignee
                                let-rowIndex="rowIndex"
                              >
                                <tr class="expanded-table-body-row">
                                  <td class="expanded-table-body-cell">
                                    {{
                                      assignee?.userName
                                        ? assignee?.userName
                                        : '-
                                            -'
                                    }}
                                  </td>
                                  <td
                                    class="expanded-table-body-cell"
                                    [style]="{
                                      'max-width': '170px',
                                      'word-wrap': 'break-word'
                                    }"
                                  >
                                    <p-multiSelect
                                      [options]="projectAssigneeEmailsCopy"
                                      *ngIf="
                                        projectCapacityEditMode;
                                        else showUserEmail
                                      "
                                      defaultLabel="Select Emails"
                                      class="multiselect-custom"
                                      [style]="{ width: '160px' }"
                                      display="chip"
                                      showClear="true"
                                      optionLabel="name"
                                      optionValue="value"
                                      [formControl]="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.email
                                      "
                                      (onChange)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'email'
                                        )
                                      "
                                      (onClear)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'email',
                                          true
                                        )
                                      "
                                    >
                                    </p-multiSelect>

                                    <ng-template #showUserEmail>{{
                                      assignee?.email ? assignee?.email : '- -'
                                    }}</ng-template>
                                  </td>
                                  <td class="expanded-table-body-cell">
                                    <app-rating
                                      [editable]="projectCapacityEditMode"
                                      [currentAssignee]="assignee"
                                    ></app-rating>
                                  </td>
                                  <td class="expanded-table-body-cell">
                                    <p-dropdown
                                      placeholder="Select Domain"
                                      [options]="projectAssigneeRoles"
                                      optionLabel="name"
                                      optionValue="value"
                                      *ngIf="
                                        projectCapacityEditMode;
                                        else showRole
                                      "
                                      [style]="{ width: '150px' }"
                                      [formControl]="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.role
                                      "
                                      (onChange)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'role'
                                        )
                                      "
                                    ></p-dropdown>
                                    <ng-template #showRole>{{
                                      assignee?.role
                                        ? projectAssigneeRolesObj[
                                            assignee?.role
                                          ]
                                        : '- -'
                                    }}</ng-template>
                                  </td>
                                  <!--For Scrum Squad-->
                                  <td
                                    class="expanded-table-body-cell"
                                    *ngIf="selectedSquad.length > 0"
                                  >
                                    <p-dropdown
                                      placeholder="Select Squad"
                                      [options]="selectedSquad"
                                      optionLabel="nodeName"
                                      optionValue="nodeId"
                                      *ngIf="
                                        projectCapacityEditMode;
                                        else showSquad
                                      "
                                      [style]="{ width: '150px' }"
                                      [formControl]="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.squad
                                      "
                                      (onChange)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'squad'
                                        )
                                      "
                                    ></p-dropdown>
                                    <ng-template #showSquad>
                                      {{ getNodeName(assignee) }}
                                    </ng-template>
                                  </td>
                                  <td class="expanded-table-body-cell">
                                    <input
                                      type="number"
                                      min="0"
                                      pInputText
                                      *ngIf="
                                        projectCapacityEditMode;
                                        else showPlannedCapacity
                                      "
                                      (input)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'plannedCapacity'
                                        )
                                      "
                                      [style]="{ width: '60px' }"
                                      [formControl]="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.plannedCapacity
                                      "
                                      (keypress)="validateInput($event)"
                                    />
                                    <ng-template #showPlannedCapacity>{{
                                      assignee?.plannedCapacity
                                        ? assignee?.plannedCapacity
                                        : '- -'
                                    }}</ng-template>
                                  </td>
                                  <td
                                    class="expanded-table-body-cell"
                                    [style]="{ position: 'relative' }"
                                  >
                                    <input
                                      type="number"
                                      min="0"
                                      (keypress)="validateInput($event)"
                                      pInputText
                                      *ngIf="
                                        projectCapacityEditMode;
                                        else showLeaves
                                      "
                                      [formControl]="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.leaves
                                      "
                                      (input)="
                                        calculateAvaliableCapacity(
                                          assignee,
                                          this.selectedSprintAssigneFormArray[
                                            rowIndex
                                          ],
                                          'leaves'
                                        )
                                      "
                                      [style]="{ width: '60px' }"
                                      [ngClass]="{
                                        'ng-invalid':
                                          selectedSprintAssigneFormArray[
                                            rowIndex
                                          ]?.leaves?.errors
                                      }"
                                    />
                                    <small
                                      *ngIf="
                                        selectedSprintAssigneFormArray[rowIndex]
                                          ?.leaves?.errors &&
                                        projectCapacityEditMode
                                      "
                                      class="p-error-block"
                                      >value must be less than or equal to
                                      plannedCapacity.</small
                                    >
                                    <ng-template #showLeaves>{{
                                      assignee?.leaves
                                        ? assignee?.leaves
                                        : '-
                                                -'
                                    }}</ng-template>
                                  </td>
                                  <td class="expanded-table-body-cell">
                                    {{
                                      assignee?.availableCapacity
                                        ? assignee?.availableCapacity
                                        : '- -'
                                    }}
                                  </td>
                                </tr>
                              </ng-template>
                              <ng-template pTemplate="emptymessage">
                                <tr class="expanded-table-body-row">
                                  <td
                                    colspan="5"
                                    class="expanded-table-body-cell no-assignee"
                                  >
                                    Click on Manage Users to add users.
                                  </td>
                                </tr>
                              </ng-template>
                            </p-table>
                          </div>
                          <div
                            class="p-d-flex p-justify-end p-mt-3 p-mb-3"
                            *ngIf="projectCapacityEditMode"
                          >
                            <button
                              pButton
                              pRipple
                              label="Cancel"
                              icon="pi pi-times"
                              class="p-button-cancel p-button-outlined p-button-secondary p-button-text p-mr-2 p-button-sm"
                              (click)="onSprintCapacityCancel(item)"
                            ></button>
                            <button
                              pButton
                              pRipple
                              label="Save"
                              icon="pi pi-save"
                              class="p-button-secondary p-button-sm"
                              (click)="onSprintCapacitySave(item)"
                              [disabled]="
                                !isAdminForSelectedProject ||
                                selectedSprintAssigneValidator?.length > 0
                              "
                            ></button>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
            <ng-template #noDataTemp>
              <div
                class="p-xl-12 p-pl-0 p-p-r-0 no-data-available"
                *ngIf="noData"
              >
                No data Available for Selected Project
              </div>
              <div
                class="p-xl-12 p-pl-0 p-p-r-0 no-data-available"
                *ngIf="tableLoader && !loader"
              >
                <div class="min-ht">
                  <div class="loading-img"></div>
                </div>
              </div>
            </ng-template>
          </ng-template>
        </div>
      </div>
    </div>
    <ng-template #noDataTemp>
      <div class="p-xl-12 no-projects" *ngIf="!loader">
        <div *ngIf="kanban; else noScrumData" class="error-msg">
          You do not have access to any Kanban project
        </div>
        <ng-template #noScrumData>
          <div class="error-msg">
            You do not have access to any Scrum project
          </div>
        </ng-template>
      </div>
    </ng-template>
  </div>
</div>
<!--add or remove assignees through manage users!-->
<p-dialog
  header="Add/Remove Users"
  [(visible)]="displayAssignee"
  [modal]="true"
  (onShow)="onAssigneeModalOpen()"
  [breakpoints]="{ '960px': '75vw', '640px': '100vw' }"
  [style]="{ width: '50vw' }"
>
  <app-manage-assignee
    [assigneeList]="manageAssigneeList"
    #manageAssignee
  ></app-manage-assignee>
  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Cancel"
      icon="pi pi-times"
      class="p-button-cancel p-button-secondary p-button-text p-mr-2 p-button-sm"
      (click)="displayAssignee = false"
    ></button>

    <button
      pButton
      pRipple
      label="Save"
      icon="pi pi-save"
      class="p-button-secondary p-button-sm"
      [disabled]="!isAdminForSelectedProject"
      (click)="addRemoveAssignees()"
    ></button>
  </ng-template>
</p-dialog>
<p-dialog
  [(visible)]="showPopuup"
  [modal]="true"
  [style]="{ width: '50vw' }"
  [baseZIndex]="10000"
  [draggable]="false"
  [resizable]="false"
  *ngIf="
    selectedView === 'upload_tep' || selectedView === 'upload_Sprint_Capacity'
  "
>
  <form
    [formGroup]="popupForm"
    class="p-fluid p-xl-12 p-p-0"
    *ngIf="selectedView === 'upload_tep'; else noToggleCapacityPopups"
  >
    <div class="form-group p-xl-12 pad-l-0">
      <label class="mr-sm-2" *ngIf="kanban; else scrumTemp">
        <span>For Execution Date {{ executionDate | isoDateFormat }}</span>
      </label>
      <ng-template #scrumTemp>
        <label class="mr-sm-2">
          <span>For {{ selectedSprintName }}:</span>
        </label>
      </ng-template>
    </div>
    <div class="form-group p-field p-mb-0 required p-xl-12 pad-l-0">
      <label for="totalTestCases" class="mr-sm-2 float-left">
        <span>Enter "Total test cases"</span>
      </label>
      <input
        type="number"
        pInputText
        class="form-control p-p-2 mb-2 mr-sm-2"
        [placeholder]="'Enter total test cases'"
        formControlName="totalTestCases"
        (input)="numericInputUpDown($event)"
        (keydown)="enterNumericValue($event)"
      />
    </div>
    <div class="form-group p-field p-mb-0 required p-xl-12 pad-l-0">
      <label for="executedTestCase" class="mr-sm-2 float-left">
        <span>Enter "Executed test cases"</span>
      </label>
      <input
        type="number"
        pInputText
        class="form-control p-p-2 mb-2 mr-sm-2"
        [placeholder]="'Enter executed test cases'"
        formControlName="executedTestCase"
        (input)="numericInputUpDown($event)"
        (keydown)="enterNumericValue($event)"
      />
    </div>

    <div class="form-group p-field p-mb-0 required p-xl-12 pad-l-0">
      <label for="passedTestCase" class="mr-sm-2 float-left">
        <span>Enter "Passed test cases"</span>
      </label>
      <input
        type="number"
        pInputText
        class="form-control p-p-2 mb-2 mr-sm-2"
        [placeholder]="'Enter passed test cases'"
        formControlName="passedTestCase"
        (input)="numericInputUpDown($event)"
        (keydown)="enterNumericValue($event)"
      />
    </div>
  </form>

  <ng-template #noToggleCapacityPopups>
    <div
      *ngIf="
        selectedView === 'upload_Sprint_Capacity' && selectedSquad.length === 0;
        else sprintCapacityPopupFormTemp2
      "
    >
      <ng-container
        *ngTemplateOutlet="sprintCapacityPopupFormTemp1"
      ></ng-container>
    </div>
  </ng-template>

  <ng-template #sprintCapacityPopupFormTemp1>
    <form [formGroup]="popupForm" class="p-xl-12 p-p-0">
      <div class="form-group p-field p-mb-0 required p-xl-12 pad-l-0">
        <label for="capacity" class="mr-sm-2 float-left">
          <span *ngIf="kanban"
            >Enter 'Team capacity' for the days between
            {{ this.startDate | isoDateFormat }} to
            {{ this.endDate | isoDateFormat }}
          </span>
          <span *ngIf="!kanban"
            >Enter "Team capacity for {{ selectedSprintName }}"</span
          >
        </label>
        <input
          type="number"
          pInputText
          class="form-control w-100 p-p-2 mb-2 mr-sm-2"
          (input)="numericInputUpDown($event)"
          (keydown)="enterNumericValue($event)"
          [placeholder]="'Enter value'"
          formControlName="capacity"
        />
      </div>
    </form>
  </ng-template>

  <ng-template #sprintCapacityPopupFormTemp2>
    <!-- Another form or content here -->
    <form [formGroup]="squadForm" class="p-xl-12 p-p-0" *ngIf="showPopuup">
      <div class="form-group p-field p-mb-0 required p-xl-12 pad-l-0">
        <div
          class="form-group p-field p-mb-0 required p-xl-12 pad-l-0"
          *ngFor="let squad of selectedSquad"
        >
          <label [for]="squad.nodeId" class="mr-sm- float-left"
            >Enter capacity for {{ squad.nodeName }}</label
          >
          <input
            type="number"
            pInputText
            class="form-control w-100 p-p-2 mb-2 mr-sm-2"
            id="{{ squad.nodeId }}"
            [formControlName]="squad.nodeId"
            (input)="numericInputUpDown($event)"
            (keydown)="enterNumericValue($event)"
            [placeholder]="'Enter value'"
            min="0"
          />
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <p
      class="text-danger p-text-left p-mt-0"
      [hidden]="!isTestExecutionSaveDisabled"
      *ngIf="selectedView === 'upload_tep'; else sprintCapacityErrorTemp"
    >
      {{ testExecutionErrorMessage }}
    </p>
    <ng-template #sprintCapacityErrorTemp>
      <p
        class="text-danger p-text-left p-mt-0"
        [hidden]="!isCapacitySaveDisabled"
      >
        {{ capacityErrorMessage }}
      </p>
    </ng-template>
    <div class="p-d-flex p-justify-end p-align-center p-mt-1 btn-container">
      <button
        pButton
        pRipple
        label="Cancel"
        icon="pi pi-times"
        class="p-button-cancel p-button-secondary p-button-text p-mr-2 p-button-sm"
        (click)="showPopuup = false; clearSquadForm()"
      ></button>
      <button
        pButton
        pRipple
        label="Save"
        icon="pi pi-save"
        class="p-button-secondary p-button-sm"
        (click)="submitTestExecution()"
        [disabled]="isTestExecutionSaveDisabled"
        *ngIf="selectedView === 'upload_tep'; else capacitySubmitTemp"
      ></button>
      <ng-template #capacitySubmitTemp>
        <button
          pButton
          pRipple
          label="Save"
          icon="pi pi-save"
          [disabled]="isCapacitySaveDisabled"
          class="p-button-secondary p-button-sm"
          (click)="submitCapacity()"
        ></button>
      </ng-template>
    </div>
  </ng-template>
</p-dialog>
<app-page-loader *ngIf="loader"></app-page-loader>
